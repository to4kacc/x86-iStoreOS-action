name: ç”ŸæˆOTAå‡çº§æ–‡ä»¶ï¼ˆæœ€è¿‘5ä¸ªç‰ˆæœ¬ï¼‰

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTC 2:00è‡ªåŠ¨è¿è¡Œ

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: æ£€å‡ºä¸»åˆ†æ”¯
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: è·å–æœ€è¿‘5ä¸ªå›ºä»¶
        id: get_releases
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const crypto = require('crypto');
            const { promisify } = require('util');
            const stream = require('stream');
            const pipeline = promisify(stream.pipeline);

            try {
              // 1. è·å–æœ€è¿‘5ä¸ªå‘å¸ƒï¼ˆåˆ†é¡µå¤„ç†ï¼‰
              const releases = await github.paginate(
                github.rest.repos.listReleases,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  per_page: 5,  // åªè·å–æœ€æ–°5ä¸ª
                  request: { timeout: 15000 }
                }
              );

              if (releases.length === 0) {
                throw new Error('ä»“åº“ä¸­æ²¡æœ‰å‘å¸ƒç‰ˆæœ¬');
              }

              console.log(`ğŸ“¦ å…±è·å– ${releases.length} ä¸ªå‘å¸ƒ`);

              // 2. å¤„ç†æ¯ä¸ªå‘å¸ƒçš„å›ºä»¶
              const processAsset = async (release, asset) => {
                console.log(`â³ å¤„ç† ${release.tag_name} çš„ ${asset.name}`);
                
                // æµå¼ä¸‹è½½è®¡ç®—SHA256
                const hash = crypto.createHash('sha256');
                const response = await fetch(asset.browser_download_url);
                await pipeline(response.body, hash);
                
                return {
                  version: release.tag_name,
                  build_date: Math.floor(new Date(release.published_at).getTime() / 1000),
                  filename: asset.name,
                  size: asset.size,
                  sha256sum: hash.digest('hex'),
                  url: asset.browser_download_url.replace(
                    'github.com', 
                    'mirror.example.com'  // ä»£ç†æ›¿æ¢
                  ),
                  release_url: release.html_url
                };
              };

              // 3. å¹¶è¡Œå¤„ç†æ‰€æœ‰æœ‰æ•ˆå›ºä»¶
              const allFirmwares = [];
              for (const release of releases) {
                const validAssets = release.assets.filter(a => 
                  a.name.toLowerCase().includes('openwrt') && 
                  /combined.*efi\.img\.gz$/i.test(a.name)
                );

                if (validAssets.length === 0) {
                  console.warn(`âš ï¸ ${release.tag_name} æ— æœ‰æ•ˆå›ºä»¶`);
                  continue;
                }

                for (const asset of validAssets) {
                  allFirmwares.push(await processAsset(release, asset));
                }
              }

              if (allFirmwares.length === 0) {
                throw new Error('æ‰€æœ‰å‘å¸ƒä¸­å‡æœªæ‰¾åˆ°æœ‰æ•ˆå›ºä»¶');
              }

              // 4. æŒ‰æ„å»ºæ—¥æœŸé™åºæ’åº
              const sortedFirmwares = allFirmwares.sort((a, b) => b.build_date - a.build_date);
              console.log(`âœ… å…±å¤„ç† ${sortedFirmwares.length} ä¸ªæœ‰æ•ˆå›ºä»¶`);

              // 5. ç”Ÿæˆå…ƒæ•°æ®
              const metadata = {
                updated_at: new Date().toISOString(),
                versions: sortedFirmwares.slice(0, 5),  // ç¡®ä¿æœ€å¤š5ä¸ª
                count: sortedFirmwares.length
              };

            //const buildDate = Math.floor(new Date(workflowStartTime).getTime() / 1000);

            
            const json = {
              "x86_64": [
                {
                  "build_date": String(build_date),
                  "sha256sum": sha256,
                  "url": proxiedUrl  // ä½¿ç”¨å¸¦ä»£ç†çš„URL
                }
              ]
            };
            //const fs = require('fs');
            fs.mkdirSync('tmp-api', { recursive: true });
            fs.writeFileSync('tmp-api/fw.json', JSON.stringify(json, null, 4));    
        
              // è®¾ç½®è¾“å‡º
              core.setOutput('latest_version', sortedFirmwares[0].version);
              core.setOutput('total_firmwares', sortedFirmwares.length);
              return metadata;

            } catch (error) {
              core.setFailed(`å¤„ç†å¤±è´¥: ${error.message}`);
              process.exit(1);
            }

      - name: æ›´æ–°APIåˆ†æ”¯
        run: |
          # é…ç½®Git
          git config --global user.name "OTA Updater"
          git config --global user.email "ota@users.noreply.github.com"
          
          # æ£€å‡ºapiåˆ†æ”¯
          git fetch origin api
          git checkout api
          
          # æ›´æ–°æ–‡ä»¶
          mkdir -p tmp-api
          cp -fv tmp-api/fw.json .
          
          # æäº¤å˜æ›´
          if ! git diff --quiet --exit-code; then
            git add fw.json
            git commit -m "æ›´æ–°å›ºä»¶åˆ—è¡¨: ${{ steps.get_releases.outputs.latest_version }}ç­‰${{ steps.get_releases.outputs.total_firmwares }}ä¸ªç‰ˆæœ¬"
            git push origin api
            echo "âœ… å·²æ›´æ–°apiåˆ†æ”¯"
          else
            echo "âš ï¸ æ— å˜æ›´éœ€è¦æäº¤"
          fi

      - name: æ¸…ç†
        run: rm -rf tmp-api
